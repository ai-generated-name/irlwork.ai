# irlwork.ai API Reference

> **This document reflects the actual implementation** as of the current codebase. It was generated by auditing `api/server.js`, `api/routes/stripe.js`, `api/routes/admin.js`, `api/config/constants.js`, `api/config/mcp-methods.js`, and `api/middleware/adminAuth.js`. Where the implementation differs from `ARCHITECTURE.md`, the inconsistency is noted in Section 10.

---

## 1. Overview

| Property | Value |
|---|---|
| **Base URL** | `https://api.irlwork.ai/api` (production) / `http://localhost:3002/api` (dev) |
| **Content Type** | `application/json` (all endpoints except Stripe webhook) |
| **Body Limit** | 5 MB (`express.json({ limit: '5mb' })`) |
| **Platform Fee** | 15% (hardcoded in `api/config/constants.js`) |

---

## 2. Authentication

Three authentication methods are supported, checked in order of preference:

### 2.1 Supabase JWT (preferred)

Send the Supabase `access_token` in the `Authorization` header. The server calls `supabase.auth.getUser()` to verify.

```
Authorization: Bearer <supabase_jwt>
```

### 2.2 API Key

API keys use the `irl_sk_` prefix with HMAC-SHA256 hashing. The plaintext key is never stored; only the hash is persisted in the `api_keys` table.

```
Authorization: irl_sk_<64_hex_chars>
```

Legacy keys are auto-migrated from unsalted SHA-256 to HMAC on first use.

### 2.3 UUID Tokens (deprecated)

UUID-based tokens are **no longer accepted**. Clients must use Supabase JWT or API key.

### 2.4 Admin Authentication

Admin access is gated by the `ADMIN_USER_IDS` environment variable (comma-separated UUIDs). Admin routes use a middleware chain: `setUser` (resolves token to user) then `adminAuth` (checks UUID against the allowlist). Returns 401 if unauthenticated, 403 if not admin.

---

## 3. Rate Limits

| Scope | Limit | Window | Key |
|---|---|---|---|
| Authenticated (global) | 300 requests | 1 minute | API key hash or IP hash |
| Unauthenticated (global) | 100 requests | 1 minute | IP hash |
| MCP endpoint | 60 requests | 1 minute | API key hash |
| Sensitive endpoints (login, register) | 10 attempts | 15 minutes | IP + path (in-memory) |
| Login attempts | 10 attempts | 15 minutes | IP hash (stored in DB) |
| Human registration | 5 registrations | 1 hour | IP hash (stored in DB) |
| Agent registration | 5 registrations | 1 hour | IP hash (stored in DB) |
| Email verification | 5 requests | 15 minutes | IP hash (stored in DB) |
| Task reports | 10 reports | 1 hour | IP hash (stored in DB) |

**Rate limit headers** are included on every response:

```
X-RateLimit-Limit: 300
X-RateLimit-Remaining: 297
X-RateLimit-Reset: 1700000000
```

**429 response body:**
```json
{
  "error": "Rate limit exceeded",
  "limit": 300,
  "remaining": 0,
  "reset_at": "2024-01-01T00:00:00.000Z",
  "retry_after_seconds": 45
}
```

### Security Measures

- **Error sanitization**: All Stripe route errors return generic `'Payment service error. Please try again.'` instead of leaking Stripe SDK internals. Database errors are sanitized via `safeErrorMessage()` which blocks schema-revealing patterns.
- **SAFE_USER_COLUMNS**: User joins in API responses use `SAFE_USER_COLUMNS` (excludes `password_hash`, `api_key`, `stripe_customer_id`, `stripe_account_id`, `webhook_secret`). Defined in `server.js`.
- **Evidence URL validation**: Dispute evidence URLs are validated via `validateEvidenceUrls()` — HTTPS only, max 10 URLs.
- **Webhook idempotency**: Stripe events use atomic INSERT-first claim. On handler failure, the claim row is deleted so Stripe can retry.

---

## 4. CORS

Configured via `CORS_ORIGINS` env var. Defaults:

- **Production:** `https://www.irlwork.ai`, `https://irlwork.ai`, `https://api.irlwork.ai`
- **Development:** adds `http://localhost:5173`, `http://localhost:5180`, `http://localhost:3002`

Allowed methods: `GET, POST, PUT, DELETE, OPTIONS, PATCH`
Allowed headers: `Content-Type, Authorization`

---

## 5. Endpoints by Domain

### 5.1 Health & Utility

#### `GET /health`
Public. No auth required.
```json
{ "status": "ok", "timestamp": "2024-01-01T00:00:00.000Z" }
```

#### `GET /ready`
Public. No auth required.
```json
{ "status": "ready", "supabase": true }
```

#### `GET /api/health`
Extended health check with DB connectivity test.
```json
{ "status": "ok", "name": "irlwork.ai", "db": "ok", "timestamp": "..." }
```

#### `GET /api/cities/search`
Public. City autocomplete. Query: `?q=<string>&limit=<1-20>`. Min 2 chars.
```json
[{ "name": "San Francisco", "country": "USA", "countryCode": "US", "state": "California", "stateCode": "CA", "lat": 37.77, "lng": -122.41, "displayName": "San Francisco, California, USA" }]
```

#### `GET /api/countries/search`
Public. Country search. Query: `?q=<string>&limit=<1-50>`. Returns all countries if no query.
```json
[{ "name": "USA", "code": "US" }]
```

#### `GET /api/stats`
Public. Platform-wide statistics.
```json
{ "humans": 150, "tasks": 42, "cities": 28 }
```

#### `GET /api/activity/feed`
Public. Recent platform activity (last 10 tasks created/completed).
```json
[{ "type": "posted", "message": "New task posted in San Francisco", "created_at": "..." }]
```

---

### 5.2 Authentication

#### `POST /api/auth/register/human`
Public. Register a human worker. Rate limited: 5/hour per IP.

**Request:**
```json
{
  "id": "uuid (optional, from Supabase auth)",
  "email": "required",
  "password": "optional",
  "name": "required",
  "city": "required",
  "state": "string",
  "hourly_rate": 25,
  "categories": ["delivery", "errands"],
  "skills": ["delivery", "errands"],
  "bio": "string",
  "phone": "string",
  "latitude": 37.77,
  "longitude": -122.41,
  "travel_radius": 25,
  "country": "USA",
  "country_code": "US"
}
```

**Response (200):**
```json
{
  "user": { "id": "uuid", "email": "...", "name": "...", "type": "human", "city": "...", "hourly_rate": 25, "skills": [], "needs_onboarding": false },
  "token": "hex_string"
}
```

On duplicate email/id, updates existing user instead of failing.

#### `POST /api/auth/register-agent`
Public. Register an AI agent. Rate limited: 5/hour per IP.

**Request:**
```json
{
  "email": "required",
  "password": "required (min 8 chars)",
  "agent_name": "optional",
  "webhook_url": "optional"
}
```

**Response (201):**
```json
{
  "user_id": "uuid",
  "agent_name": "string",
  "api_key": "irl_sk_...",
  "token": "uuid",
  "message": "Save this API key -- it won't be shown again."
}
```

#### `POST /api/auth/login`
Public. Login with email/password. Rate limited: 10 attempts per 15 min per IP.

**Request:**
```json
{ "email": "required", "password": "required" }
```

**Response (200):**
```json
{
  "user": { "id": "uuid", "email": "...", "name": "...", "type": "human|agent", "email_verified": true },
  "token": "hex_string"
}
```

Supports bcrypt and legacy SHA-256 hashes (auto-migrates to bcrypt on success).

#### `GET /api/auth/verify`
Auth required. Verify JWT token and return full user profile.

**Response (200):** Full user object including `skills`, `languages`, `social_links`, reputation metrics (`total_tasks_completed`, `completion_rate`, `payment_rate`), `needs_onboarding`, `email_verified`, and `avatar_url`.

#### `GET /api/auth/google`
Public. Redirects to Supabase Google OAuth. Redirect URL comes from `FRONTEND_URL` env var only (never from query params, to prevent open redirect).

#### `GET /api/auth/google/callback`
OAuth callback. Creates user if not exists, then redirects to frontend.

#### `POST /api/auth/onboard`
Auth required (JWT). Idempotent onboarding completion. Creates or updates user with location, skills, and profile data. Sets `needs_onboarding: false`.

**Request:**
```json
{
  "email": "string",
  "name": "string",
  "city": "required",
  "latitude": "required",
  "longitude": "required",
  "country": "string",
  "country_code": "string",
  "hourly_rate": 25,
  "skills": ["delivery"],
  "travel_radius": 25,
  "role": "human",
  "bio": "string",
  "avatar_url": "string"
}
```

#### `POST /api/auth/send-verification`
Auth required. Sends a 6-digit email verification code (30-minute expiry). Works for both existing users and onboarding users (JWT valid but no DB row yet).

**Rate limit:** 5 requests per 15 minutes per IP.

#### `POST /api/auth/verify-email`
Auth required. Verify the 6-digit code.

**Request:**
```json
{ "code": "123456" }
```

#### Password Reset (Frontend)

Password reset is handled client-side via Supabase Auth:
- **`/forgot-password`** — Calls `supabase.auth.resetPasswordForEmail(email, { redirectTo })`. Always shows a success message regardless of whether the email exists (prevents enumeration).
- **`/reset-password`** — Calls `supabase.auth.updateUser({ password })`. Validates minimum 8 characters and password confirmation match. Redirects to `/auth?reset=success` on success.

No backend endpoints are required — Supabase Auth handles token generation, email sending, and password updating.

---

### 5.3 API Key Management

All endpoints require JWT or API key auth.

#### `POST /api/keys/generate`
Generate a new API key.

**Request:**
```json
{ "name": "My Key (optional)" }
```

**Response (201):**
```json
{
  "id": "uuid",
  "api_key": "irl_sk_...",
  "key_prefix": "irl_sk_abcd...",
  "name": "API Key",
  "created_at": "...",
  "message": "Save this API key -- it won't be shown again."
}
```

#### `GET /api/keys`
List all API keys for the authenticated user. Returns metadata only (never the key itself).

#### `DELETE /api/keys/:id`
Revoke an API key. Verifies ownership. Sets `is_active: false`.

#### `POST /api/keys/:id/rotate`
Revoke old key and generate a new one atomically. Returns new key.

---

### 5.4 Users & Profiles

#### `GET /api/users/:id`
Get a user's public profile. If requesting own profile (auth matches), includes email and `total_paid`.

#### `GET /api/profile`
Auth required. Get the authenticated user's full profile with reputation metrics.

#### `PUT /api/profile`
Auth required. Update profile fields: `name`, `bio`, `city`, `state`, `hourly_rate`, `skills`, `availability`, `avatar_url`, `languages`, `travel_radius`, `social_links`.

#### `GET /api/users/:id/ratings`
Public. Get visible ratings for a user. Returns `ratings[]`, `averageRating`, and `totalRatings`.

---

### 5.5 Humans (Workers)

#### `GET /api/humans`
Public. Browse available human workers. Query params: `category`, `city`, `min_rate`, `max_rate`, `user_lat`, `user_lng`, `radius`.

#### `GET /api/humans/:id`
Public. Get a human's profile summary.

#### `GET /api/humans/directory`
Public (with auth-aware pagination). Browse humans with pagination and sorting.

Query params: `category`, `city`, `country`, `skill`, `name`, `min_rate`, `max_rate`, `limit` (default 16), `offset`, `sort` (rating|price_low|price_high|most_reviewed|most_completed|newest).

**Response:**
```json
{
  "humans": [...],
  "total": 150,
  "limit": 16,
  "offset": 0,
  "hasMore": true
}
```

#### `GET /api/humans/:id/profile`
Public. Full human profile with reviews and derived metrics (completion_rate, payment_rate). Strips sensitive fields (email, password_hash, stripe IDs).

#### `PUT /api/humans/profile`
Auth required. Update human profile. Accepts: `name`, `hourly_rate`, `bio`, `skills`, `categories`, `city`, `latitude`, `longitude`, `travel_radius`, `country`, `country_code`, `social_links`, `headline`, `languages`, `timezone`, `avatar_url`. Auto-derives timezone from coordinates.

---

### 5.6 Tasks

#### `GET /api/tasks`
Public. Browse tasks. Query params: `category`, `city`, `urgency`, `status`, `my_tasks` (bool), `user_lat`, `user_lng`, `radius_km`. Excludes moderated and expired tasks from browse (unless `my_tasks`).

#### `GET /api/tasks/available`
Public. Optimized task browse with distance-based search (uses Supabase RPC `search_tasks_nearby`). Includes remote tasks. Paginated.

Query params: `category`, `city`, `urgency`, `limit` (default 16), `offset`, `user_lat`, `user_lng`, `radius_km`, `search`, `sort` (distance|pay_high|pay_low), `include_remote`, `skills` (comma-separated).

**Response:**
```json
{
  "tasks": [...],
  "total": 42,
  "hasMore": true
}
```

#### `GET /api/tasks/my-tasks`
Auth required. Get tasks for the authenticated user (human: assigned tasks; agent: created tasks).

#### `GET /api/my-tasks`
Auth required. Alternative my-tasks endpoint with creator/assignee joins.

#### `POST /api/tasks`
Auth required. Create a new task. Returns `402 payment_required` if agent has no payment method (Stripe card or crypto wallet) on file.

**Request:**
```json
{
  "title": "required (max 200 chars)",
  "description": "max 5000 chars",
  "category": "general",
  "location": "max 300 chars",
  "budget": "required, min $5, max $100,000",
  "latitude": 37.77,
  "longitude": -122.41,
  "is_remote": false,
  "duration_hours": "required, positive number, max 720 (30 days)",
  "deadline": "ISO 8601",
  "requirements": "max 3000 chars",
  "required_skills": ["delivery"],
  "is_anonymous": false,
  "task_type": "open|direct",
  "quantity": 1,
  "max_humans": 1,
  "country": "USA",
  "country_code": "US"
}
```

#### `POST /api/tasks/create`
Auth required (agents only). Alternative task creation endpoint. Non-remote tasks must include latitude/longitude.

#### `GET /api/tasks/:id`
Public (partial) / Auth (full). Get task detail. Non-participants see a filtered view without escrow/payment fields. Includes `poster` and `applicant_count`.

#### `GET /api/tasks/:id/status`
Get task status with escrow info, proof submissions, and dispute window info.

#### `GET /api/tasks/:id/stats`
Public. Application count and view count for a task.

#### `PATCH /api/tasks/:id`
Auth required (task owner). Update an open task. Allowed fields: `title`, `description`, `category`, `budget`, `location`, `latitude`, `longitude`, `urgency`, `required_skills`, `is_remote`, `duration_hours`, `spots_total`, `deadline`, `instructions`, `payment_type`.

#### `POST /api/tasks/:id/apply`
Auth required (human). Apply to a task. Task must be in `open` status. Returns `403` if user is the task creator. Returns `400` if task is not open. Returns `404` if task not found. Returns `409` with `deadline_passed` error if the task's deadline has passed. Notifies the task creator via notification and webhook (`new_application` event).

**Request:**
```json
{
  "cover_letter": "string",
  "availability": "string",
  "questions": "string",
  "proposed_rate": 30
}
```

#### `GET /api/tasks/:id/applications`
Auth required (task owner). List applications for a task with applicant details.

#### `PATCH /api/tasks/:id/applications/:applicationId`
Auth required (task owner). Update an application status. Task must be `open`.

**Request:**
```json
{ "status": "rejected" }
```

**Response:**
```json
{ "id": "uuid", "status": "rejected" }
```

Returns `403` if not task owner. Returns `400` if task is not open or invalid status. Notifies applicant if rejected (`application_rejected` event).

#### `POST /api/tasks/:id/assign`
Auth required (task owner). Assign a human to a task. Stripe path: charges agent's card immediately and moves task to `in_progress` with `escrow_status: 'deposited'`. USDC path: manual deposit flow. Requires agent to have a payment method on file (returns 402 `card_required` if not).

**Request:**
```json
{ "human_id": "uuid", "payment_method_id": "optional" }
```

#### `POST /api/tasks/:id/accept`
Auth required (human). Accept a task offer. For `pending_acceptance` tasks, charges the agent's card via Stripe. Returns 410 if review deadline expired. Returns 402 if payment fails.

#### `POST /api/tasks/:id/decline`
Auth required (human). Decline a task offer. Reverts task to open.

**Request:**
```json
{ "reason": "optional string" }
```

#### `POST /api/tasks/:id/start`
Auth required (assigned human). Mark work started. Only for tasks in `assigned` or `accepted` status.

#### `POST /api/tasks/:id/cancel`
Auth required (task owner **or** assigned worker). Task owner can cancel `open`, `pending_acceptance`, `assigned`, or `in_progress` tasks (sets status to `cancelled`). Assigned worker can withdraw from `assigned` or `in_progress` tasks — this reopens the task, refunds escrow if funded, and notifies the agent (`worker_cancelled` event).

#### `GET /api/tasks/:id/proofs`
Auth required (task participant). Get submitted proofs for a task.

#### `POST /api/tasks/:id/submit-proof`
Auth required (assigned human, type=human). Submit proof of work. Task must be `in_progress`. Moves task to `pending_review`. Notifies agent and delivers webhook. If proof is submitted after the task's deadline, `submitted_late` is set to `true` on the proof record and an additional `proof_submitted_late` notification + webhook is sent to the poster.

**Request:**
```json
{
  "proof_text": "string",
  "proof_urls": ["https://..."]
}
```

#### `POST /api/tasks/:id/reject`
Auth required (task owner). Reject a proof submission. Auto-escalates to dispute after 3 rejections. Extends deadline.

**Request:**
```json
{
  "feedback": "string",
  "extend_deadline_hours": 24
}
```

#### `POST /api/tasks/:id/request-extension`
Auth required (assigned worker). Request a deadline extension. Task must be `in_progress` or `assigned` with a deadline set. Returns `409` if a pending request already exists (enforced by DB partial unique index). Proposed deadline must be in the future and no more than 30 days from now. Notifies poster via `extension_requested` notification + webhook.

**Request:**
```json
{
  "reason": "string (required)",
  "proposed_deadline": "ISO 8601 timestamp (required)"
}
```

#### `POST /api/tasks/:id/respond-extension`
Auth required (task poster). Respond to a pending extension request. Actions: `approve` (uses proposed deadline), `decline`, `modify` (requires `modified_deadline`). Modified deadline must be future and max 30 days. On approve/modify: updates task deadline, resets `deadline_warning_sent` to 0. Notifies worker via `extension_approved` or `extension_declined` notification + webhook.

**Request:**
```json
{
  "request_id": "uuid (required)",
  "action": "approve | decline | modify (required)",
  "modified_deadline": "ISO 8601 timestamp (required if action=modify)",
  "response_note": "string (optional)"
}
```

#### `POST /api/tasks/:id/extend-deadline`
Auth required (task poster). Directly extend deadline without an extension request. Task must be `in_progress` or `assigned`. Provide exactly one of `new_deadline` or `extend_hours`. New deadline must be future and max 30 days. Auto-resolves any pending extension requests. Resets `deadline_warning_sent` to 0. Notifies worker via `deadline_extended` notification + webhook.

**Request:**
```json
{
  "new_deadline": "ISO 8601 timestamp (one of)",
  "extend_hours": "number (one of)"
}
```

#### `GET /api/tasks/:id/extension-requests`
Auth required (task poster or assigned worker). Returns all deadline extension requests for the task, ordered by `created_at` descending. Includes requester profile (name, avatar_url).

#### `POST /api/tasks/:id/approve`
Auth required (task owner). Approve proof and release payment. Task must be in `pending_review` or `disputed`. For Stripe-paid tasks, auto-releases payment to pending balance with 48-hour hold.

#### `POST /api/tasks/:id/release`
Auth required (task owner). Legacy release payment endpoint. Uses Stripe pipeline with 48-hour hold.

#### `POST /api/tasks/:id/rate`
Auth required (task participant). Rate the other party (1-5 stars). Task must be finalized (paid or dispute resolved). Blind rating: ratings become visible when both parties rate or after 72 hours.

**Request:**
```json
{
  "rating_score": 5,
  "comment": "optional"
}
```

#### `GET /api/tasks/:id/ratings`
Auth required (task participant). Get ratings for a specific task. Shows visibility status and whether user can still rate.

#### `POST /api/tasks/:id/report`
Auth required. Report a task. Rate limited: 10/hour per IP.

**Request:**
```json
{
  "reason": "scam_fraud|misleading|inappropriate|spam|illegal|harassment|other",
  "description": "required, max 2000 chars"
}
```

Auto-flags at 3+ reports, auto-hides at 5+ reports.

#### `GET /api/tasks/:id/reports/check`
Auth required. Check if the authenticated user has already reported a task.

#### `POST /api/tasks/:id/dispute`
Auth required (task participant — agent or assigned worker). Opens a dispute and atomically transitions task status to `disputed`. Only for disputable statuses (`in_progress`, `pending_review`). Freezes any pending payouts.

**Request:**
```json
{ "reason": "required string" }
```

**Response (200):** `{ "success": true, "status": "disputed", "dispute_id": "uuid" }`
**Errors:** 409 if status transition invalid, 409 if dispute already exists.

#### `GET /api/tasks/:id/context`

Auth required (API key, agent type, task creator only). Returns full session context for a task in a single call — status history, applications, messages, payment state, proof, disputes, and deadlines.

**Query Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| include_messages | boolean | true | Set false to skip message history |
| message_limit | integer | 50 | Max messages returned (most recent first, max 200) |

**Response (200):**
```json
{
  "task": { "id", "title", "description", "instructions", "status", "budget", "deadline", "created_at", "location", "category" },
  "status_history": [{ "from_status", "to_status", "changed_at", "changed_by", "reason" }],
  "applications": [{ "id", "worker_id", "worker_name", "worker_rating", "status", "cover_letter", "proposed_rate", "applied_at" }],
  "assigned_worker": { "id", "name", "rating", "completed_tasks" } | null,
  "messages": [{ "id", "sender_id", "content", "sent_at" }],
  "payment": { "method", "amount_authorized", "amount_captured", "escrow_status", "stripe_payment_intent_id" },
  "proof": { "submitted", "submitted_at", "photos", "notes" } | null,
  "dispute": { "id", "status", "reason", "opened_at", "opened_by" } | null,
  "deadlines": { "task_deadline", "auto_approve_at", "dispute_window_closes_at" },
  "meta": { "retrieved_at", "message_count", "unread_webhook_events" }
}
```

**Errors:** 401 Unauthorized, 403 Not task creator, 404 Task not found

---

### 5.7 Disputes

#### `POST /api/disputes`
Auth required (agent or assigned worker). File a dispute with evidence. Atomically transitions task status to `disputed`. Freezes any pending payouts.

**Request:**
```json
{
  "task_id": "required",
  "reason": "required",
  "category": "quality_issue|other",
  "evidence_urls": ["https://..."]
}
```

**Note:** Both `/api/tasks/:id/dispute` and `/api/disputes` now have the same behavior: they validate the status transition, atomically update task status to `disputed`, create a dispute record, freeze payouts, and send notifications/webhooks.

#### `POST /api/admin/resolve-dispute` (DEPRECATED)
Returns 301 redirect to `POST /api/disputes/:id/resolve`. Use the canonical endpoint instead.

#### `GET /api/disputes`
Auth required. List disputes filed by or against the authenticated user. Query: `?status=open|resolved`.

#### `GET /api/disputes/:id`
Auth required. Get a specific dispute by ID. Only accessible by the parties involved (`filed_by` or `filed_against`).

**Response (200):**
```json
{
  "dispute": {
    "id": "uuid",
    "task_id": "uuid",
    "payout_id": "uuid",
    "filed_by": "uuid",
    "filed_against": "uuid",
    "reason": "string",
    "category": "quality_issue",
    "status": "open",
    "evidence_urls": ["https://..."],
    "resolution_notes": null,
    "resolved_by": null,
    "resolved_at": null,
    "created_at": "...",
    "updated_at": "...",
    "task": { "...full task object..." },
    "payout": { "...full payout object..." },
    "filed_by_user": { "id": "uuid", "name": "Agent Name" },
    "filed_against_user": { "id": "uuid", "name": "Human Name" },
    "resolved_by_user": null
  }
}
```

**Errors:** 401 unauthorized, 403 if not a party to the dispute, 404 dispute not found.

#### `POST /api/disputes/:id/resolve`
Admin only. Resolve an open dispute. Three resolution paths:

1. **Refund agent** (`refund_agent: true`): Refunds via Stripe, freezes worker's pending transactions, sets task to `cancelled` / `escrow_status: refunded`.
2. **Release to human** (`release_to_human: true`): Releases payment to worker's pending balance (with 48-hour hold), sets task to `paid`.
3. **Partial** (`resolution: "partial"`): Resets task to `pending_review` for re-review by the agent.
4. **Default** (no flags): Releases payout to human.

**Request:**
```json
{
  "resolution": "approved | rejected | partial",
  "resolution_notes": "optional string",
  "refund_agent": false,
  "release_to_human": false
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Dispute resolved",
  "resolution": "approved",
  "task_status": "paid"
}
```

**Errors:** 400 invalid resolution (must be `approved`, `rejected`, or `partial`), 400 dispute already resolved, 401 unauthorized, 403 admin required, 404 dispute not found, 409 payment already released, 500 Stripe refund failed.

#### `POST /api/admin/resolve-dispute`
Admin only. Resolve a dispute with one of three outcomes: release to human, refund to agent, or reset to pending_review.

**Request:**
```json
{
  "task_id": "required",
  "resolution": "string",
  "release_to_human": false,
  "refund_to_agent": false,
  "notes": "string"
}
```

---

### 5.8 Messaging

#### `GET /api/conversations`
Auth required. List conversations with unread counts, task info, and participant details.

#### `POST /api/conversations`
Auth required. Create or get existing conversation (upsert on `human_id,agent_id,task_id`).

**Request:**
```json
{ "agent_id": "uuid", "task_id": "uuid (optional)" }
```

#### `GET /api/conversations/:id`
Auth required. Get conversation detail with task and participant info.

#### `GET /api/messages/:conversation_id`
Auth required. Get messages with cursor-based pagination. Query: `?limit=<1-100>&before=<msg_id>&after=<msg_id>&after_time=<ISO8601>`.

#### `POST /api/messages`
Auth required. Send a message (max 10,000 chars). Triggers notification, email (throttled to 1 per 5 min per conversation), and webhook to the other party.

**Request:**
```json
{ "conversation_id": "uuid", "content": "required string" }
```

#### `PUT /api/messages/:id/read`
Auth required. Mark a single message as read. Only marks messages from other senders.

#### `PUT /api/conversations/:id/read-all`
Auth required. Mark all messages in a conversation as read. Also clears related notifications.

#### `GET /api/conversations/unread`
Auth required. Get unread message summary via Supabase RPC `get_unread_summary`.

#### `GET /api/messages/unread/count`
Auth required. Get total unread message count across all conversations.

---

### 5.9 Notifications

#### `GET /api/notifications`
Auth required. List all notifications for the user, ordered by `created_at` descending.

#### `POST /api/notifications/:id/read`
Auth required. Mark a notification as read (sets `is_read: true`).

---

### 5.10 Payments & Wallet

#### `GET /api/wallet/balance`
Auth required. Get wallet balance breakdown.

**Response:**
```json
{
  "user_id": "uuid",
  "pending": 50.00,
  "available": 25.00,
  "total": 75.00,
  "pending_cents": 5000,
  "available_cents": 2500,
  "total_cents": 7500
}
```

#### `POST /api/wallet/withdraw`
Auth required. Request withdrawal to connected bank (Stripe Connect). Requires `stripe_account_id`.

**Request:**
```json
{ "amount_cents": 2500 }
```

Returns 400 with `action: "connect_stripe"` if no bank connected.

#### `GET /api/wallet/withdrawals`
Auth required. Withdrawal history.

#### `GET /api/wallet/status`
Auth required. Combined wallet balance, Stripe Connect status, and transaction details.

#### `GET /api/transactions`
Auth required. List payouts and pending transactions for the user, merged and sorted by date.

#### `GET /api/deposits`
Auth required. List manual payment deposits (from `manual_payments` table).

#### `GET /api/payouts`
Auth required. List payout history for the user.

---

### 5.11 Stripe

All Stripe routes (except `publishable-key`) require auth.

#### `GET /api/stripe/publishable-key`
Public. Returns the Stripe publishable key.

#### `POST /api/stripe/setup-intent`
Auth required. Create a Stripe SetupIntent for saving a card via Stripe Elements (frontend).

**Response:**
```json
{ "client_secret": "seti_..._secret_...", "setup_intent_id": "seti_..." }
```

#### `POST /api/stripe/checkout-setup`
Auth required. Create a Stripe Checkout Session in `setup` mode. Returns a hosted URL where the user can add a credit card without requiring Stripe Elements. Used by MCP agents who cannot render frontend JavaScript.

**Response:**
```json
{ "url": "https://checkout.stripe.com/c/pay/...", "session_id": "cs_..." }
```

The URL expires after 24 hours. On completion, a `checkout.session.completed` webhook fires with `mode: 'setup'`, which sets the card as default (if no existing default) and sends a `payment_method_added` notification to the user.

#### `GET /api/stripe/payment-methods`
Auth required. List saved payment methods (cards).

#### `DELETE /api/stripe/payment-methods/:id`
Auth required. Remove a saved card. Verifies ownership.

#### `POST /api/stripe/payment-methods/:id/default`
Auth required. Set a card as default payment method.

#### `POST /api/stripe/connect/onboard`
Auth required. Start Stripe Connect onboarding for workers. Returns onboarding URL.

**Response:**
```json
{
  "account_id": "acct_...",
  "onboarding_url": "https://connect.stripe.com/..."
}
```

#### `GET /api/stripe/connect/dashboard`
Auth required. Get Stripe Express Dashboard link for workers to manage bank accounts.

#### `POST /api/stripe/connect/update-bank`
Auth required. Generate new onboarding link to update bank details.

#### `GET /api/stripe/connect/status`
Auth required. Check Connect account status.

**Response:**
```json
{
  "connected": true,
  "stripe_account_id": "acct_...",
  "payouts_enabled": true,
  "details_submitted": true
}
```

#### `POST /api/stripe/webhooks`
Stripe webhook endpoint. Must be before `express.json()` (uses raw body). Verifies signature with `STRIPE_WEBHOOK_SECRET`.

---

### 5.12 Webhooks

#### `POST /api/webhooks/register`
Auth required. Register or update a webhook URL and optional signing secret. URL must be HTTPS and not target private/internal addresses (SSRF prevention).

**Request:**
```json
{
  "webhook_url": "https://your-server.com/webhook",
  "webhook_secret": "optional_secret"
}
```

#### `GET /api/agents/:id/webhook-url`
Get the webhook URL for an agent.

#### `POST /webhooks/receive`
Auth required (API key, agent type). Receive and store webhook notifications.

#### `GET /webhooks/test`
Auth required (API key, agent type). Test webhook connectivity.

---

### 5.13 File Uploads

#### `POST /api/upload/proof`
Auth required. Upload proof-of-work file to R2 (or demo mode). Max 10 MB.

**Request:**
```json
{
  "file": "base64 or data URL",
  "filename": "photo.jpg",
  "mimeType": "image/jpeg"
}
```

Allowed extensions: `jpg, jpeg, png, gif, webp, mp4, mov, pdf`. Validates magic bytes.

#### `POST /api/upload/avatar`
Auth required. Upload avatar to R2 (max 5 MB). Stores R2 key + base64 fallback in DB. Returns proxy URL with cache-buster.

#### `GET /api/avatar/:userId`
Public. Avatar serve proxy. Tries R2 first, falls back to DB base64, then trusted external URLs only (`lh3.googleusercontent.com`, `avatars.githubusercontent.com`, `cdn.irlwork.ai`).

#### `GET /api/avatar/:userId/debug`
Admin only. Diagnostic endpoint for troubleshooting avatar storage issues. Tests R2 connectivity and base64 data integrity.

**Response (200):**
```json
{
  "user_id": "uuid",
  "avatar_url": "https://...",
  "avatar_r2_key": "avatars/uuid-timestamp.jpg",
  "has_avatar_data": true,
  "avatar_data_length": 45000,
  "avatar_data_preview": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
  "updated_at": "2024-01-01T00:00:00.000Z",
  "r2_configured": true,
  "r2_bucket": "irlwork-proofs",
  "r2_test": "OK — 32450 bytes, type=image/jpeg",
  "avatar_data_test": "OK — 32450 bytes decoded, type=image/jpeg",
  "diagnosis": "SHOULD_WORK_VIA_R2"
}
```

Diagnosis values: `NO_AVATAR_URL`, `NO_STORAGE`, `SHOULD_WORK_VIA_R2`, `SHOULD_WORK_VIA_DB`, `MISSING_BOTH_R2_AND_DB_DATA`.

**Errors:** 403 if not admin.

#### `POST /api/upload/feedback`
Auth required. Upload feedback attachment to R2. Max 10 MB.

---

### 5.14 Feedback

#### `POST /api/feedback`
Auth required. Submit feedback or bug report.

**Request:**
```json
{
  "type": "feedback|bug|feature_request|other",
  "urgency": "low|normal|high|critical",
  "subject": "optional",
  "message": "required",
  "image_urls": [],
  "page_url": "string"
}
```

Critical feedback notifies admins.

---

### 5.15 Agent-Specific

#### `GET /api/agent/prompt`
Public. Get the dynamic agent system prompt (single source of truth). Returns `version`, `prompt`, `template`, and `updated_at`.

#### `GET /api/agent/tasks`
Auth required (agent type). Get the agent's tasks with pending applicant counts. Query: `?status=<string>&limit=50`.

---

### 5.16 Page Views

#### `POST /api/views`
Public (optional auth). Track page views with deduplication.

**Request:**
```json
{
  "page_type": "task|profile",
  "target_id": "uuid",
  "referrer": "optional",
  "ai_source": "optional"
}
```

---

## 6. Admin Endpoints

All admin endpoints require JWT auth + admin user ID in `ADMIN_USER_IDS` env var. Mounted at `/api/admin`.

#### `GET /api/admin/dashboard`
Summary stats: pending deposits, stale deposits (48h+), work in progress, pending agent approval, pending release, pending withdrawals, platform fees, reports, feedback.

#### `GET /api/admin/pending-stats`
Aggregate stats on pending/available/frozen transactions.

#### `GET /api/admin/tasks/pending-deposits`
Tasks awaiting deposit confirmation. Includes hours_pending and expected_deposit.

#### `GET /api/admin/tasks/stale-deposits`
Pending deposits older than 48 hours.

#### `POST /api/admin/tasks/:id/confirm-deposit`
Confirm an on-chain deposit.

**Request:**
```json
{
  "tx_hash": "required",
  "amount_received": "required (number)",
  "notes": "required if amount mismatch"
}
```

#### `POST /api/admin/tasks/:id/cancel-assignment`
Cancel an unfunded assignment. Resets task to open.

**Request:**
```json
{ "reason": "optional" }
```

#### `GET /api/admin/tasks/:id`
Full task detail with payment history and proofs.

#### `GET /api/admin/tasks/pending-agent-approval`
Tasks with proof submitted, awaiting agent review.

#### `GET /api/admin/tasks/pending-release`
Agent-approved tasks awaiting admin payment release. Includes fee calculations.

#### `POST /api/admin/tasks/:id/release-payment`
Release payment to worker. Calculates fees server-side (15%). Uses atomic update with precondition to prevent double-release.

#### `GET /api/admin/payments/pending-withdrawals`
Payments ready for transfer with worker Stripe info.

#### `POST /api/admin/payments/:id/confirm-withdrawal`
**DEPRECATED (410).** Returns: "Withdrawals are now handled automatically via Stripe Connect."

#### `POST /api/admin/tasks/:id/refund`
Refund agent via Stripe. Requires `reason`.

#### `GET /api/admin/reports`
List task reports. Query: `?status=pending|all&reason=<string>&task_id=<uuid>&page=1&limit=20`. Enriched with reporter, task, agent, and resolver info.

#### `POST /api/admin/reports/:id/resolve`
Resolve a report. Actions: `no_action`, `warning_issued`, `task_hidden`, `task_removed`, `user_suspended`, `user_banned`.

**Request:**
```json
{
  "action": "required (one of the above)",
  "notes": "optional",
  "suspend_days": 7
}
```

Batch-resolves other pending reports for the same task on task-level actions.

#### `GET /api/admin/feedback`
List all feedback. Query: `?status=<string>&urgency=<string>&type=<string>&limit=50&offset=0`. Sorted by urgency priority.

#### `PUT /api/admin/feedback/:id/status`
Update feedback status.

**Request:**
```json
{
  "status": "new|in_review|resolved|dismissed",
  "admin_notes": "optional"
}
```

#### `POST /api/admin/resolve-dispute`
Admin dispute resolution (in server.js, not admin router).

#### `POST /api/admin/check-auto-release`
**DISABLED (410).** "Auto-release is disabled for Phase 1."

---

## 7. Webhooks

### 7.1 Outbound Webhooks (Platform to Agent)

The platform delivers webhooks to registered URLs on key events. Delivery is fire-and-forget with a 5-second timeout.

**Payload format:**
```json
{
  "event_type": "string",
  "task_id": "uuid",
  "data": { ... },
  "timestamp": "ISO 8601"
}
```

**HMAC Verification:** If `webhook_secret` is configured, an `X-Webhook-Signature` header is included:
```
X-Webhook-Signature: HMAC-SHA256(webhook_secret, JSON.stringify(payload))
```

**Event types:**
| Event | Trigger | Dispatch Function |
|---|---|---|
| `new_application` | Human applies to a task | `dispatchWebhook` |
| `application_rejected` | Agent rejects an application | `dispatchWebhook` |
| `task_assigned` | Agent assigns a worker (escrow charged) | `dispatchWebhook` |
| `worker_cancelled` | Worker withdraws from task | `dispatchWebhook` |
| `proof_submitted` | Human submits proof of work | `deliverWebhook` |
| `proof_rejected` | Agent rejects proof | `deliverWebhook` |
| `proof_approved` | Agent approves proof | `deliverWebhook` |
| `dispute_opened` | Dispute filed on task | `deliverWebhook` |
| `new_message` | Message sent in conversation | `dispatchWebhook` |

> **Note: Two webhook dispatch functions exist** with different payload structures:
> - `deliverWebhook(agentId, payload)` — Used for task lifecycle events. Sends the payload object directly as the webhook body (flat structure).
> - `dispatchWebhook(userId, event)` — Used for messaging events. Wraps the event in a standardized envelope: `{event_type, task_id, data: {...}, timestamp}`.

**Example payloads per event type:**

**`proof_submitted`** (via `deliverWebhook`):
```json
{
  "event": "proof_submitted",
  "task_id": "uuid",
  "proof_id": "uuid",
  "human_id": "uuid",
  "human_name": "Jane Worker",
  "task_title": "Deliver package to downtown",
  "timestamp": "2024-01-15T14:30:00.000Z"
}
```

**`proof_rejected`** (via `deliverWebhook`):
```json
{
  "event": "proof_rejected",
  "task_id": "uuid",
  "proof_id": "uuid",
  "feedback": "Photo is blurry, please retake",
  "new_deadline": "2024-01-16T14:30:00.000Z",
  "timestamp": "2024-01-15T15:00:00.000Z"
}
```

**`proof_approved`** (via `deliverWebhook`):
```json
{
  "event": "proof_approved",
  "task_id": "uuid",
  "proof_id": "uuid",
  "message": "Proof approved. Payment will be processed.",
  "timestamp": "2024-01-15T16:00:00.000Z"
}
```

**`dispute_opened`** (via `deliverWebhook`):
```json
{
  "event": "dispute_opened",
  "task_id": "uuid",
  "disputed_by": "uuid",
  "reason": "Work was not completed as specified",
  "timestamp": "2024-01-15T17:00:00.000Z"
}
```

**`new_message`** (via `dispatchWebhook` — note the wrapped envelope format):
```json
{
  "event_type": "new_message",
  "task_id": "uuid",
  "data": {
    "conversation_id": "uuid",
    "message_id": "uuid",
    "sender_name": "Agent Smith",
    "sender_type": "agent",
    "content": "Hello, I have a question about the task.",
    "created_at": "2024-01-15T18:00:00.000Z"
  },
  "timestamp": "2024-01-15T18:00:00.000Z"
}
```

**SSRF Prevention:** Webhook URLs must be HTTPS. Blocked: `localhost`, `127.0.0.1`, `0.0.0.0`, `::1`, `169.254.169.254`, private IP ranges (10.x, 192.168.x, 172.16-31.x), metadata endpoints.

### 7.2 Stripe Webhooks (Stripe to Platform)

Endpoint: `POST /api/stripe/webhooks`

Uses raw body (before `express.json()`) for signature verification with `STRIPE_WEBHOOK_SECRET`.

---

## 8. Error Codes

### 8.1 HTTP Status Codes

| Code | Meaning |
|---|---|
| 200 | Success |
| 201 | Created (agent registration, key generation) |
| 400 | Bad request / Validation error |
| 401 | Unauthorized / Invalid token |
| 402 | Payment required (no card on file, code: `card_required`) |
| 403 | Forbidden / Access denied / Admin required |
| 404 | Not found |
| 409 | Conflict (duplicate, concurrent modification, already processed) |
| 410 | Gone (deprecated endpoint) |
| 413 | Payload too large (file upload) |
| 429 | Rate limit exceeded |
| 500 | Internal server error |
| 502 | Bad gateway (R2/Stripe communication failure) |
| 503 | Service unavailable (Stripe not configured) |

### 8.2 Standard Error Response

```json
{ "error": "Human-readable error message" }
```

Some endpoints include additional fields:
```json
{
  "error": "No payment method on file",
  "code": "card_required",
  "message": "You must link a payment card before hiring."
}
```

### 8.3 Error Sanitization

Database/SQL errors are sanitized before reaching clients. Patterns matching `duplicate key`, `violates constraint`, `relation does not exist`, `permission denied`, etc. are replaced with "An internal error occurred".

### 8.4 Task Status Transitions

```
open -> pending_acceptance | assigned | in_progress | cancelled
pending_acceptance -> in_progress | open | cancelled
assigned -> in_progress | cancelled
in_progress -> pending_review | disputed | cancelled
pending_review -> completed | rejected | disputed
rejected -> pending_review | disputed | cancelled
disputed -> paid | refunded | cancelled
completed -> paid
```

---

## 9. MCP (Model Context Protocol) Endpoint

### In-Process MCP: `POST /api/mcp`

Embedded in the main server. Auth: API key + agent type required. Rate limit: 60/min.

**Request:**
```json
{
  "method": "method_name",
  "params": { ... }
}
```

**Available methods:**

| Method | Description |
|---|---|
| `list_humans` | Search humans. Params: `category`, `city`, `state`, `min_rating`, `language`, `availability`, `limit` |
| `get_human` | Get human profile. Params: `human_id` |
| `create_posting` | Create a public task. Aliases: `post_task`, `create_adhoc_task`. Required params: `title`, `duration_hours` (positive number, max 720). Optional: `description`, `category`, `budget`, `location`, `latitude`, `longitude`, `is_remote`, `deadline`, `requirements`, `required_skills`, `is_anonymous`, `task_type`, `quantity` |
| `direct_hire` | Hire human directly. Alias: `create_booking` |
| `hire_human` | Hire with Stripe (send offer, charge on accept). Params: `task_id`, `human_id`, `deadline_hours`, `instructions` |
| `assign_human` | Assign human (USDC path). Params: `task_id`, `human_id`, `deadline_hours`, `instructions` |
| `my_tasks` | List agent's tasks. Aliases: `get_tasks`, `my_postings`, `my_adhoc_tasks`, `my_bookings` |
| `get_task_status` | Get task status with escrow info |
| `get_task_details` | Get full task detail with participant info |
| `get_applicants` | Get applicants for a task |
| `complete_task` | Submit proof (as human). Alias: `complete_booking` |
| `approve_task` | Approve and release payment. Aliases: `release_payment`, `release_escrow`. Sends email + webhook + in-app notification |
| `reject_task` | Reject proof and request revision (max 2). Alias: `reject_proof`. Params: `task_id`, `feedback` (required, min 10 chars), `extend_deadline_hours` (default 24). Sends notification + webhook |
| `cancel_task` | Cancel task (pre-work) or withdraw (worker). Handles refunds. Params: `task_id`, `cancellation_reason` |
| `view_proof` | View proof submissions |
| `dispute_task` | File a dispute. Both agent and human can dispute. Sends email to both parties + webhook |
| `start_conversation` | Start conversation with human. Params: `human_id`/`humanId`, `message` |
| `send_message` | Send message. Params: `conversation_id`, `content` |
| `get_messages` | Get messages. Params: `conversation_id`, `since` |
| `get_unread_summary` | Get unread message summary |
| `notifications` | Get notifications |
| `mark_notification_read` | Mark notification read. Params: `notification_id` |
| `set_webhook` | Register webhook URL |
| `task_templates` | Get task category templates. Params: `category` |
| `submit_feedback` | Submit platform feedback (bug reports, feature requests). NOT for task reviews — use `rate_task` instead. Params: `message`, `type` (feedback/bug/feature_request/other), `urgency`, `subject` |
| `setup_payment` | Set up a payment method. Returns Stripe card setup URL or USDC deposit instructions. Params: `method` (optional, `stripe` or `usdc`). Omit `method` to see current status and all options. |
| `account_status` | Get account status including payment methods, subscription tier, and setup actions needed. No params required. |
| `rate_task` | Rate a worker after task completion. Inserts into blind rating system. Params: `task_id` (required), `rating_score` (1-5, required), `comment` (optional) |
| `report_error` | Report agent error. Params: `action`, `error_message`, `error_code`, `error_log` |
| `get_task_context` | Full session context for a task. Same as `GET /api/tasks/:id/context`. Params: `task_id` (required), `include_messages` (optional, default true), `message_limit` (optional, default 50). Uses the shared `buildTaskContext()` helper — no behavioral differences from REST. |

### MCP Method Documentation: `GET /api/mcp/docs`

Public endpoint (no authentication required). Returns the full MCP method catalog as structured JSON. Agents fetch this at runtime to discover available methods and parameters.

**Query Parameters:**
- `method` (optional) — Return a single method by name: `?method=list_humans`
- `category` (optional) — Filter by category: `?category=tasks`

**Response:**
```json
{
  "methods": [
    {
      "name": "list_humans",
      "aliases": [],
      "category": "search",
      "description": "Search for available humans by category, city, rating, skills, and more",
      "params": {
        "category": { "type": "string", "required": false, "description": "Filter by skill category" }
      },
      "returns": "Array of human profiles matching filters"
    }
  ],
  "categories": { "search": "Search & Discovery", "tasks": "Tasks", ... },
  "auth": { "type": "bearer", "header": "Authorization", "format": "Bearer YOUR_API_KEY" },
  "base_url": "https://api.irlwork.ai/api",
  "endpoint": "POST /api/mcp",
  "rate_limits": { "requests": "60/min per API key" },
  "total_methods": 27
}
```

**Examples:**
```bash
curl https://api.irlwork.ai/api/mcp/docs
curl https://api.irlwork.ai/api/mcp/docs?method=create_posting
curl https://api.irlwork.ai/api/mcp/docs?category=messaging
```

### Agent Prompt: `GET /api/agent/prompt`

Returns the agent system prompt. Supports `?verbose=true` to get the full v2 prompt with all method signatures inline (for agents that cannot make HTTP calls).

**Response:**
```json
{
  "version": 3,
  "prompt": "...",
  "template": "...",
  "docs_url": "https://www.irlwork.ai/api/mcp/docs",
  "verbose": false,
  "updated_at": "2026-02-27T..."
}
```

### MCP vs REST Behavioral Differences

As of Track D parity fixes, all MCP methods that map to REST endpoints now have equivalent behavior:

- **Validation**: Both use shared validators from `api/utils/validate.js`
- **Notifications**: Both trigger the same in-app, email, and webhook notifications
- **Status transitions**: Both use the same atomic status guards
- **Payment ops**: Both call the same `releasePaymentToPending()` / refund functions

New MCP methods added in Track D: `reject_task` (reject proof with feedback), `cancel_task` (cancel/withdraw with refund handling).

Removed: `api/mcp-server.js` standalone MCP server (7 dead endpoint calls) — all MCP is now in-process at `POST /api/mcp`.

### Validation Rules (shared between REST and MCP)

| Field | Rules |
|---|---|
| Task title | Required, 1-200 chars |
| Task description | Max 5,000 chars |
| Task requirements | Max 3,000 chars |
| Task location | Max 300 chars |
| Task instructions | Max 10,000 chars |
| Task budget | Required, $5-$100,000 |
| Task duration_hours | Required, 0.1-720 (30 days) |
| Message content | Required, 1-10,000 chars |
| Message attachments | Max 5, each must have url + filename |
| Dispute reason | Required, 10-2,000 chars |
| Rejection feedback | Required, 10-2,000 chars |
| Rating score | Required, 1-5 |
| Profile name | Max 100 chars |
| Profile bio | Max 1,000 chars |

### Error Response Format

All endpoints return errors in this standardized shape:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "status": 400,
    "details": ["Title is required", "Budget must be at least $5"]
  }
}
```

Common error codes: `VALIDATION_ERROR`, `NOT_FOUND`, `CONFLICT`, `UNAUTHORIZED`, `FORBIDDEN`, `PAYMENT_REQUIRED`, `RATE_LIMIT_EXCEEDED`.

Legacy endpoints may still return `{ "error": "string message" }`. The frontend `getErrorMessage()` utility handles both formats.

### MCP Payment Setup Flow

When an MCP agent has no payment method configured, `create_posting`, `hire_human`, and `direct_hire` return HTTP 402 with an `actions` array guiding the agent to the `setup_payment` tool:

```json
{
  "error": "No payment method on file",
  "code": "payment_required",
  "message": "Use the setup_payment tool to add a credit card or configure USDC.",
  "actions": [
    { "tool": "setup_payment", "params": { "method": "stripe" }, "label": "Add credit card" },
    { "tool": "setup_payment", "params": { "method": "usdc" }, "label": "Set up USDC" }
  ]
}
```

`setup_payment` returns a Stripe Checkout URL (for cards) or platform wallet address + instructions (for USDC). `account_status` returns a general readiness check without needing to attempt a specific operation.

For `direct_hire` with `payment_currency: 'usdc'`, the guard checks that the agent's USDC available balance covers the task budget. For Stripe (default), it checks for at least one card on file.

### MCP Streamable HTTP (IDE Integration): `POST /api/mcp/sse`

Standard MCP protocol endpoint for IDE integration (Cursor, Claude Desktop, VS Code, Windsurf). Speaks JSON-RPC 2.0 over HTTP. Auth: `Authorization: Bearer <api_key>` header.

Supported JSON-RPC methods:
- `initialize` — Returns server capabilities and protocol version (`2024-11-05`)
- `notifications/initialized` — Acknowledgement (no-op)
- `tools/list` — Returns all available tool definitions with input schemas
- `tools/call` — Executes a tool by name, forwarding to the in-process MCP handler (`POST /api/mcp`)
- `ping` — Health check

**IDE Configuration Examples:**

Cursor (one-click install via deeplink):
```
cursor://anysphere.cursor-deeplink/mcp/install?name=irlwork&config=<base64-encoded-json>
```
Config: `{"url":"https://api.irlwork.ai/api/mcp/sse","headers":{"Authorization":"Bearer API_KEY"}}`

VS Code (`.vscode/mcp.json`):
```json
{"servers":{"irlwork":{"type":"http","url":"https://api.irlwork.ai/api/mcp/sse","headers":{"Authorization":"Bearer API_KEY"}}}}
```

Claude Desktop (`claude_desktop_config.json`):
```json
{"mcpServers":{"irlwork":{"url":"https://api.irlwork.ai/api/mcp/sse","headers":{"Authorization":"Bearer API_KEY"}}}}
```

Windsurf (`mcp_config.json`):
```json
{"mcpServers":{"irlwork":{"serverUrl":"https://api.irlwork.ai/api/mcp/sse","headers":{"Authorization":"Bearer API_KEY"}}}}
```

### Standalone MCP Server: `POST /mcp`

Separate Node.js process (`api/mcp-server.js`) on port 3004 (configurable via `MCP_PORT`). Proxies to the main API. Auth: `IRLWORK_API_KEY` env var.

> **⚠️ WARNING: The standalone MCP server is largely broken.** Several methods proxy to REST endpoints that no longer exist in `server.js`. The following methods will return 404 errors:
>
> | MCP Method | Calls | Status |
> |---|---|---|
> | `create_posting` | `POST /api/ad-hoc` | ❌ Endpoint removed |
> | `direct_hire` | `POST /api/bookings` | ❌ Endpoint removed |
> | `my_tasks` | `GET /api/bookings` | ❌ Endpoint removed |
> | `complete_task` | `POST /api/bookings/:id/complete` | ❌ Endpoint removed |
> | `hire_human` | `POST /api/tasks/:id/hire` | ❌ Endpoint removed |
> | `task_templates` | `GET /api/task-templates` | ❌ No REST endpoint |
> | `mark_notification_read` | `PATCH /api/notifications/:id/read` | ❌ Wrong method (should be POST) |
>
> Use the **in-process MCP** (`POST /api/mcp`) instead, which accesses the database directly and works correctly.

Canonical methods: `list_humans`, `get_human`, `task_templates`, `start_conversation`, `send_message`, `get_messages`, `get_unread_summary`, `create_posting`, `direct_hire`, `my_tasks`, `get_applicants`, `assign_human`, `hire_human`, `get_task_status`, `get_task_details`, `complete_task`, `complete_booking`, `view_proof`, `approve_task`, `dispute_task`, `notifications`, `mark_notification_read`, `set_webhook`, `submit_feedback`, `setup_payment`, `account_status`, `rate_task`, `report_error`, `get_instructions`.

Backward-compatible aliases: `post_task`, `create_adhoc_task` -> `create_posting`; `create_booking` -> `direct_hire`; `get_tasks`, `my_postings`, `my_adhoc_tasks`, `my_bookings` -> `my_tasks`; `release_escrow`, `release_payment` -> `approve_task`.

Full method catalog with parameters available at `GET /api/mcp/docs`.

---

## 10. Inconsistencies: ARCHITECTURE.md vs Actual Implementation

### Endpoints in ARCHITECTURE.md That No Longer Exist

| ARCHITECTURE.md | Actual Status |
|---|---|
| `POST /api/bookings` | Replaced by `POST /api/tasks` and `POST /api/tasks/:id/assign`. The bookings concept was merged into tasks. MCP `direct_hire` still posts to `/api/bookings` on the standalone server but the in-process MCP creates tasks directly. |
| `PATCH /api/bookings/:id` | Replaced by `PATCH /api/tasks/:id` |
| `POST /api/bookings/:id/complete` | Replaced by `POST /api/tasks/:id/submit-proof` |
| `POST /api/bookings/:id/release-escrow` | Replaced by `POST /api/tasks/:id/approve` and `POST /api/tasks/:id/release` |
| `GET /api/bookings` | Replaced by `GET /api/tasks?my_tasks=true` and `GET /api/tasks/my-tasks` |
| `GET /api/ad-hoc` | Does not exist. Tasks are unified under `/api/tasks` |
| `POST /api/ad-hoc` | Does not exist. Use `POST /api/tasks` |
| `GET /api/task-templates` | Only exists as MCP method `task_templates` (hardcoded list). No REST endpoint. |
| `PATCH /api/notifications/:id/read` | Changed to `POST /api/notifications/:id/read` |
| `POST /api/verification/video` | Does not exist |
| `GET /api/verifications/:booking_id` | Does not exist |
| `POST /api/stripe/connect` | Changed to `POST /api/stripe/connect/onboard` |
| `POST /api/stripe/payment-intent` | Changed to `POST /api/stripe/setup-intent` (saves card rather than charging immediately) |
| `GET /api/humans/:id/portfolio` | Does not exist |
| `GET /api/humans/:id/certifications` | Does not exist |
| `GET /api/humans/:id/availability` | Does not exist as a separate endpoint. Availability is a field on the user profile. |
| `PATCH /api/humans/:id` | Does not exist. Use `PUT /api/humans/profile` or `PUT /api/profile` |
| `GET /api/conversations/:id/messages` | Changed to `GET /api/messages/:conversation_id` |

### Endpoints in Codebase But Not in ARCHITECTURE.md

| Endpoint | Description |
|---|---|
| `GET /api/auth/google` | Google OAuth redirect |
| `GET /api/auth/google/callback` | Google OAuth callback |
| `POST /api/auth/send-verification` | Email verification code |
| `POST /api/auth/verify-email` | Verify email code |
| `POST /api/auth/onboard` | Idempotent onboarding |
| `POST /api/keys/generate` | API key management |
| `GET /api/keys` | List API keys |
| `DELETE /api/keys/:id` | Revoke key |
| `POST /api/keys/:id/rotate` | Rotate key |
| `POST /api/tasks/:id/assign` | Assign human to task (Stripe/USDC) |
| `POST /api/tasks/:id/accept` | Human accepts task offer |
| `POST /api/tasks/:id/decline` | Human declines task offer |
| `POST /api/tasks/:id/start` | Mark work started |
| `POST /api/tasks/:id/cancel` | Cancel task |
| `POST /api/tasks/:id/submit-proof` | Submit proof of work |
| `POST /api/tasks/:id/reject` | Reject proof |
| `POST /api/tasks/:id/request-extension` | Worker requests deadline extension |
| `POST /api/tasks/:id/respond-extension` | Poster responds to extension request |
| `POST /api/tasks/:id/extend-deadline` | Poster directly extends deadline |
| `GET /api/tasks/:id/extension-requests` | List extension requests for task |
| `POST /api/tasks/:id/report` | Report task |
| `GET /api/tasks/:id/reports/check` | Check if reported |
| `POST /api/tasks/:id/dispute` | Create dispute |
| `POST /api/tasks/:id/rate` | Rate task |
| `GET /api/tasks/:id/ratings` | Get task ratings |
| `GET /api/tasks/:id/stats` | Task stats |
| `GET /api/tasks/:id/status` | Task status detail |
| `GET /api/tasks/available` | Optimized browse with RPC |
| `GET /api/tasks/my-tasks` | My tasks |
| `GET /api/my-tasks` | Alternative my-tasks |
| `POST /api/tasks/create` | Agent-only task creation |
| `GET /api/users/:id/ratings` | User ratings |
| `GET /api/humans/directory` | Paginated directory |
| `GET /api/humans/:id/profile` | Full public profile |
| `PUT /api/humans/profile` | Update human profile |
| `GET /api/profile` | Own profile |
| `PUT /api/profile` | Update own profile |
| `GET /api/wallet/balance` | Wallet balance |
| `POST /api/wallet/withdraw` | Request withdrawal |
| `GET /api/wallet/withdrawals` | Withdrawal history |
| `GET /api/wallet/status` | Wallet + Stripe status |
| `GET /api/transactions` | Transaction history |
| `GET /api/deposits` | Deposit history |
| `GET /api/payouts` | Payout history |
| `POST /api/disputes` | File formal dispute |
| `GET /api/disputes` | List disputes |
| `POST /api/upload/proof` | Upload proof file |
| `POST /api/upload/avatar` | Upload avatar |
| `GET /api/avatar/:userId` | Serve avatar |
| `POST /api/upload/feedback` | Upload feedback attachment |
| `POST /api/feedback` | Submit feedback |
| `GET /api/agent/prompt` | Agent system prompt |
| `GET /api/agent/tasks` | Agent's tasks |
| `POST /api/views` | Track page views |
| `GET /api/stats` | Platform stats |
| `GET /api/activity/feed` | Activity feed |
| `GET /api/cities/search` | City autocomplete |
| `GET /api/countries/search` | Country search |
| Stripe: `POST /setup-intent`, `POST /checkout-setup`, `GET/DELETE /payment-methods`, `POST /connect/onboard`, `GET /connect/dashboard`, `POST /connect/update-bank`, `GET /connect/status` | Full Stripe card + Connect management |
| All admin routes | Comprehensive payment, report, and feedback management |

### MCP Method Differences

| ARCHITECTURE.md | Actual |
|---|---|
| `create_booking` | Still works as alias, but canonical is `direct_hire` |
| `complete_booking` | Still works as alias, but canonical is `complete_task` |
| `release_escrow` | Still works as alias, but canonical is `approve_task` |
| `my_bookings` | Still works as alias, but canonical is `my_tasks` |
| `create_task` (listed as method) | Actually aliases to `create_posting` |
| `list_my_tasks` (listed in ARCHITECTURE.md) | Does not exist. Use `my_tasks` |
| `get_task` (listed in ARCHITECTURE.md) | Does not exist by this exact name. Use `get_task_status` or `get_task_details` |
| `approve_work` (listed in ARCHITECTURE.md) | Does not exist by this name. Use `approve_task` |
| `reject_work` (listed in ARCHITECTURE.md) | Does not exist in MCP. Use REST `POST /api/tasks/:id/reject` |
| Not in ARCHITECTURE.md | `assign_human`, `hire_human`, `get_task_status`, `get_task_details`, `get_applicants`, `view_proof`, `dispute_task`, `start_conversation`, `send_message`, `get_messages`, `get_unread_summary`, `task_templates`, `submit_feedback`, `rate_task`, `report_error`, `get_instructions` |

### Other Differences

| Area | ARCHITECTURE.md | Actual |
|---|---|---|
| Platform model | "Bookings" and "Ad Hoc" as separate concepts | Unified under "Tasks" with `task_type: open|direct` |
| Payment flow | `POST /api/stripe/payment-intent` | `POST /api/stripe/setup-intent` (save card, charge on acceptance) |
| Escrow | `POST /api/bookings/:id/release-escrow` | Multi-step: approve -> auto-release (Stripe) or admin-release (USDC) with 48-hour hold |
| Notifications read | `PATCH /api/notifications/:id/read` | `POST /api/notifications/:id/read` |
| Messages path | `GET /api/conversations/:id/messages` | `GET /api/messages/:conversation_id` |
| MCP rate limit | Listed as 60/min per key | Confirmed: 60/min per key |
| MCP auth | "API key + agent type required" | Confirmed |
